"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[63427],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=p(n),h=r,c=d["".concat(l,".").concat(h)]||d[h]||m[h]||i;return n?a.createElement(c,o(o({ref:t},u),{},{components:n})):a.createElement(c,o({ref:t},u))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>o});var a=n(67294),r=n(86010);const i={tabItem:"tabItem_Ymn6"};function o(e){let{children:t,hidden:n,className:o}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(i.tabItem,o),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>v});var a=n(87462),r=n(67294),i=n(86010),o=n(12466),s=n(16550),l=n(91980),p=n(67392),u=n(50012);function d(e){return function(e){return r.Children.map(e,(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:r}}=e;return{value:t,label:n,attributes:a,default:r}}))}function m(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??d(n);return function(e){const t=(0,p.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function h(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function c(e){let{queryString:t=!1,groupId:n}=e;const a=(0,s.k6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(i),(0,r.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(a.location.search);t.set(i,e),a.replace({...a.location,search:t.toString()})}),[i,a])]}function g(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,i=m(e),[o,s]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!h({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:i}))),[l,p]=c({queryString:n,groupId:a}),[d,g]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,i]=(0,u.Nk)(n);return[a,(0,r.useCallback)((e=>{n&&i.set(e)}),[n,i])]}({groupId:a}),k=(()=>{const e=l??d;return h({value:e,tabValues:i})?e:null})();(0,r.useLayoutEffect)((()=>{k&&s(k)}),[k]);return{selectedValue:o,selectValue:(0,r.useCallback)((e=>{if(!h({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);s(e),p(e),g(e)}),[p,g,i]),tabValues:i}}var k=n(72389);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function w(e){let{className:t,block:n,selectedValue:s,selectValue:l,tabValues:p}=e;const u=[],{blockElementScrollPositionUntilNextRender:d}=(0,o.o5)(),m=e=>{const t=e.currentTarget,n=u.indexOf(t),a=p[n].value;a!==s&&(d(t),l(a))},h=e=>{let t=null;switch(e.key){case"Enter":m(e);break;case"ArrowRight":{const n=u.indexOf(e.currentTarget)+1;t=u[n]??u[0];break}case"ArrowLeft":{const n=u.indexOf(e.currentTarget)-1;t=u[n]??u[u.length-1];break}}t?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},p.map((e=>{let{value:t,label:n,attributes:o}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>u.push(e),onKeyDown:h,onClick:m},o,{className:(0,i.Z)("tabs__item",f.tabItem,o?.className,{"tabs__item--active":s===t})}),n??t)})))}function y(e){let{lazy:t,children:n,selectedValue:a}=e;const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=i.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},i.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function N(e){const t=g(e);return r.createElement("div",{className:(0,i.Z)("tabs-container",f.tabList)},r.createElement(w,(0,a.Z)({},e,t)),r.createElement(y,(0,a.Z)({},e,t)))}function v(e){const t=(0,k.Z)();return r.createElement(N,(0,a.Z)({key:String(t)},e))}},46300:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),r=n(50012);function i(e){let{path:t}=e;const[n]=(0,r.Nk)("docusaurus.tab.js-ts"),i=t.lastIndexOf("{"),o=t.slice(i+1,t.length-1),[s,l]=o.split(","),p=t.slice(0,i);return a.createElement("code",null,p+("js"===n?s:l))}},15041:(e,t,n)=>{n.d(t,{Nl:()=>l,f3:()=>s,ge:()=>o,p5:()=>u,xQ:()=>d,xS:()=>p});var a=n(67294),r=n(39960);function i(e){let{children:t,linkToPage:n,style:i={}}=e;return a.createElement(r.Z,{to:n,style:{padding:"0.1rem 0.5rem",borderRadius:"0.375rem",color:"var(--auth-pills-color)",textDecoration:"none",display:"inline-block",...i}},t)}function o(){return a.createElement(i,{style:{backgroundColor:"var(--auth-pills-email)"},linkToPage:"/docs/auth/email"},"Email")}function s(){return a.createElement(i,{style:{backgroundColor:"var(--auth-pills-username-and-pass)"},linkToPage:"/docs/auth/username-and-pass"},"Username & Password")}function l(){return a.createElement(i,{style:{backgroundColor:"var(--auth-pills-discord)"},linkToPage:"/docs/auth/social-auth/discord"},"Discord")}function p(){return a.createElement(i,{style:{backgroundColor:"var(--auth-pills-github)"},linkToPage:"/docs/auth/social-auth/github"},"Github")}function u(){return a.createElement(i,{style:{backgroundColor:"var(--auth-pills-google)"},linkToPage:"/docs/auth/social-auth/google"},"Google")}function d(){return a.createElement(i,{style:{backgroundColor:"var(--auth-pills-keycloak)"},linkToPage:"/docs/auth/social-auth/keycloak"},"Keycloak")}},3951:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>p,default:()=>g,frontMatter:()=>l,metadata:()=>u,toc:()=>m});var a=n(87462),r=(n(67294),n(3905)),i=(n(46300),n(85162)),o=n(74866),s=n(15041);const l={title:"Migration from 0.11.X to 0.12.X"},p=void 0,u={unversionedId:"migration-guides/migrate-from-0-11-to-0-12",id:"version-0.15.0/migration-guides/migrate-from-0-11-to-0-12",title:"Migration from 0.11.X to 0.12.X",description:"To fully migrate from 0.11.X to the latest version of Wasp, you should first migrate to 0.12.X and then continue going through the migration guides.",source:"@site/versioned_docs/version-0.15.0/migration-guides/migrate-from-0-11-to-0-12.md",sourceDirName:"migration-guides",slug:"/migration-guides/migrate-from-0-11-to-0-12",permalink:"/docs/0.15.0/migration-guides/migrate-from-0-11-to-0-12",draft:!1,editUrl:"https://github.com/wasp-lang/wasp/edit/release/web/versioned_docs/version-0.15.0/migration-guides/migrate-from-0-11-to-0-12.md",tags:[],version:"0.15.0",frontMatter:{title:"Migration from 0.11.X to 0.12.X"},sidebar:"docs",previous:{title:"Migration from 0.12.X to 0.13.X",permalink:"/docs/0.15.0/migration-guides/migrate-from-0-12-to-0-13"},next:{title:"Contributing",permalink:"/docs/0.15.0/contributing"}},d={},m=[{value:"What&#39;s new in Wasp 0.12.0?",id:"whats-new-in-wasp-0120",level:2},{value:"New project structure",id:"new-project-structure",level:3},{value:"New auth",id:"new-auth",level:3},{value:"How to Migrate?",id:"how-to-migrate",level:2},{value:"Migrating Your Project to the New Structure",id:"migrating-your-project-to-the-new-structure",level:3},{value:"Migrating declaration names",id:"migrating-declaration-names",level:3},{value:"Migrating the Tailwind Setup",id:"migrating-the-tailwind-setup",level:3},{value:"Default Server Dockerfile Changed",id:"default-server-dockerfile-changed",level:3},{value:"Migrating to the New Auth",id:"migrating-to-the-new-auth",level:3},{value:"1. Migrate to the New Auth System",id:"1-migrate-to-the-new-auth-system",level:4},{value:"2. Cleanup the Old Auth System",id:"2-cleanup-the-old-auth-system",level:4},{value:"Next Steps",id:"next-steps",level:3},{value:"Appendix",id:"appendix",level:2},{value:"Example Data Migration Functions",id:"example-data-migration-functions",level:3},{value:"Username &amp; Password",id:"username--password",level:4},{value:"Email",id:"email",level:4},{value:"Google &amp; GitHub",id:"google--github",level:4}],h={toc:m},c="wrapper";function g(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("admonition",{title:"Migrating to the latest version",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"To fully migrate from 0.11.X to the latest version of Wasp, you should first migrate to ",(0,r.kt)("strong",{parentName:"p"},"0.12.X")," and then continue going through the migration guides."),(0,r.kt)("p",{parentName:"admonition"},"Make sure to read the ",(0,r.kt)("a",{parentName:"p",href:"/docs/0.15.0/migration-guides/migrate-from-0-12-to-0-13"},"migration guide from 0.12.X to 0.13.X")," after you finish this one.")),(0,r.kt)("h2",{id:"whats-new-in-wasp-0120"},"What's new in Wasp 0.12.0?"),(0,r.kt)("h3",{id:"new-project-structure"},"New project structure"),(0,r.kt)("p",null,"Here's a file tree of a fresh Wasp project created with the previous version of Wasp.\nMore precisely, this is what you'll get if you run ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp new myProject")," using Wasp 0.11.x:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},".\n\u251c\u2500\u2500 .gitignore\n\u251c\u2500\u2500 main.wasp\n\u251c\u2500\u2500 src\n\u2502\xa0\xa0 \u251c\u2500\u2500 client\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 Main.css\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 MainPage.jsx\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 react-app-env.d.ts\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 tsconfig.json\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 waspLogo.png\n\u2502\xa0\xa0 \u251c\u2500\u2500 server\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 tsconfig.json\n\u2502\xa0\xa0 \u251c\u2500\u2500 shared\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 tsconfig.json\n\u2502\xa0\xa0 \u2514\u2500\u2500 .waspignore\n\u2514\u2500\u2500 .wasproot\n")),(0,r.kt)("p",null,"Compare that with the file tree of a fresh Wasp project created with Wasp\n0.12.0. In other words, this is what you will get by running ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp new myProject"),"\nfrom this point onwards:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},".\n\u251c\u2500\u2500 .gitignore\n\u251c\u2500\u2500 main.wasp\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 public\n\u2502\xa0\xa0 \u2514\u2500\u2500 .gitkeep\n\u251c\u2500\u2500 src\n\u2502\xa0\xa0 \u251c\u2500\u2500 Main.css\n\u2502\xa0\xa0 \u251c\u2500\u2500 MainPage.jsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 queries.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 vite-env.d.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 .waspignore\n\u2502\xa0\xa0 \u2514\u2500\u2500 waspLogo.png\n\u251c\u2500\u2500 tsconfig.json\n\u251c\u2500\u2500 vite.config.ts\n\u2514\u2500\u2500 .wasproot\n\n")),(0,r.kt)("p",null,"The main differences are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The server/client code separation is no longer necessary. You can now organize\nyour code however you want, as long as it's inside the ",(0,r.kt)("inlineCode",{parentName:"li"},"src")," directory."),(0,r.kt)("li",{parentName:"ul"},"All external imports in your Wasp file must have paths starting with ",(0,r.kt)("inlineCode",{parentName:"li"},"@src")," (e.g., ",(0,r.kt)("inlineCode",{parentName:"li"},"import foo from '@src/bar.js'"),")\nwhere ",(0,r.kt)("inlineCode",{parentName:"li"},"@src")," refers to the ",(0,r.kt)("inlineCode",{parentName:"li"},"src")," directory in your project root. The paths can\nno longer start with ",(0,r.kt)("inlineCode",{parentName:"li"},"@server")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"@client"),"."),(0,r.kt)("li",{parentName:"ul"},"Your project now features a top-level ",(0,r.kt)("inlineCode",{parentName:"li"},"public")," dir. Wasp will publicly serve\nall the files it finds in this directory. Read more about it\n",(0,r.kt)("a",{parentName:"li",href:"/docs/0.15.0/project/static-assets"},"here"),".")),(0,r.kt)("p",null,"Our ",(0,r.kt)("a",{parentName:"p",href:"/docs/0.15.0/tutorial/project-structure"},"Overview docs")," explain the new\nstructure in detail, while this page provides a ",(0,r.kt)("a",{parentName:"p",href:"#migrating-your-project-to-the-new-structure"},"quick guide")," for migrating existing\nprojects."),(0,r.kt)("h3",{id:"new-auth"},"New auth"),(0,r.kt)("p",null,"In Wasp 0.11.X, authentication was based on the ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," model which the developer needed to set up properly and take care of the auth fields like ",(0,r.kt)("inlineCode",{parentName:"p"},"email")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"password"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'app myApp {\n  wasp: {\n    version: "^0.11.0"\n  },\n  title: "My App",\n  auth: {\n    userEntity: User,\n    externalAuthEntity: SocialLogin,\n    methods: {\n      gitHub: {}\n    },\n    onAuthFailedRedirectTo: "/login"\n  },\n}\n\nentity User {=psl\n  id                        Int           @id @default(autoincrement())\n  // highlight-start\n  username                  String        @unique\n  password                  String\n  externalAuthAssociations  SocialLogin[]\n  // highlight-end\npsl=}\n\n\n// highlight-start\nentity SocialLogin {=psl\n  id          Int       @id @default(autoincrement())\n  provider    String\n  providerId  String\n  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)\n  userId      Int\n  createdAt   DateTime  @default(now())\n  @@unique([provider, providerId, userId])\npsl=}\n// highlight-end\n')),(0,r.kt)("p",null,"From 0.12.X onwards, authentication is based on the auth models which are automatically set up by Wasp. You don't need to take care of the auth fields anymore."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," model is now just a business logic model and you use it for storing the data that is relevant for your app."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'app myApp {\n  wasp: {\n    version: "^0.12.0"\n  },\n  title: "My App",\n  auth: {\n    userEntity: User,\n    methods: {\n      gitHub: {}\n    },\n    onAuthFailedRedirectTo: "/login"\n  },\n}\n\nentity User {=psl\n  id Int @id @default(autoincrement())\npsl=}\n')),(0,r.kt)("admonition",{title:"Regression Note: Multiple Auth Identities per User",type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"With our old auth implementation, if you were using both Google and email auth methods, your users could sign up with Google first and then, later on, reset their password and therefore also enable logging in with their email and password. This was the only way in which a single user could have multiple login methods at the same time (Google and email)."),(0,r.kt)("p",{parentName:"admonition"},"This is not possible anymore. ",(0,r.kt)("strong",{parentName:"p"},"The new auth system doesn't support multiple login methods per user at the moment"),". We do plan to add this soon though, with the introduction of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/wasp/issues/954"},"account merging feature"),"."),(0,r.kt)("p",{parentName:"admonition"},"If you have any users that have both Google and email login credentials at the same time, you will have to pick only one of those for that user to keep when migrating them.")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("mdxAdmonitionTitle",{parentName:"admonition"},"Regression Note: ",(0,r.kt)("inlineCode",{parentName:"mdxAdmonitionTitle"},"_waspCustomValidations")," is deprecated"),(0,r.kt)("p",{parentName:"admonition"},"Auth field customization is no longer possible using the ",(0,r.kt)("inlineCode",{parentName:"p"},"_waspCustomValidations")," on the ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," entity. This is a part of auth refactoring that we are doing to make it easier to customize auth. We will be adding more customization options in the future.")),(0,r.kt)("p",null,"You can read more about the new auth system in the ",(0,r.kt)("a",{parentName:"p",href:"../auth/entities"},"Accessing User Data")," section."),(0,r.kt)("h2",{id:"how-to-migrate"},"How to Migrate?"),(0,r.kt)("p",null,"These instructions are for migrating your app from Wasp ",(0,r.kt)("inlineCode",{parentName:"p"},"0.11.X")," to Wasp ",(0,r.kt)("inlineCode",{parentName:"p"},"0.12.X"),", meaning they will work for all minor releases that fit this pattern (e.g., the guide applies to ",(0,r.kt)("inlineCode",{parentName:"p"},"0.12.0"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"0.12.1"),", ...)."),(0,r.kt)("p",null,"The guide consists of two big steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Migrating your Wasp project to the new structure."),(0,r.kt)("li",{parentName:"ol"},"Migrating to the new auth.")),(0,r.kt)("p",null,"If you get stuck at any point, don't hesitate to ask for help on ",(0,r.kt)("a",{parentName:"p",href:"https://discord.gg/rzdnErX"},"our Discord server"),"."),(0,r.kt)("h3",{id:"migrating-your-project-to-the-new-structure"},"Migrating Your Project to the New Structure"),(0,r.kt)("p",null,"You can easily migrate your old Wasp project to the new structure by following a\nseries of steps. Assuming you have a project called ",(0,r.kt)("inlineCode",{parentName:"p"},"foo")," inside the\ndirectory ",(0,r.kt)("inlineCode",{parentName:"p"},"foo"),", you should:"),(0,r.kt)("ol",{start:0},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Install the ",(0,r.kt)("inlineCode",{parentName:"strong"},"0.12.x")," version")," of Wasp.",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -sSL https://get.wasp-lang.dev/installer.sh | sh -s -- -v 0.12.4\n"))),(0,r.kt)("li",{parentName:"ol"},"Make sure to ",(0,r.kt)("strong",{parentName:"li"},"backup or save your project")," before starting the procedure (e.g.,\nby committing it to source control or creating a copy)."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Position yourself in the terminal")," in the directory that is a parent of your wasp project directory (so one level above: if you do ",(0,r.kt)("inlineCode",{parentName:"li"},"ls"),", you should see your wasp project dir listed)."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Run the migration script")," (replace ",(0,r.kt)("inlineCode",{parentName:"li"},"foo")," at the end with the name of your Wasp project directory) and follow the instructions:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"npx wasp-migrate foo\n")))),(0,r.kt)("details",null,(0,r.kt)("summary",null,"In case the migration script doesn't work well for you, you can do the same steps manually, as described here:"),(0,r.kt)("div",null,(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Rename your project's root directory to something like ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a new project by running ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp new foo"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Delete all files of ",(0,r.kt)("inlineCode",{parentName:"p"},"foo/src")," except ",(0,r.kt)("inlineCode",{parentName:"p"},"vite-env.d.ts"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old/src/client/public")," exists and contains any files, copy those files into\n",(0,r.kt)("inlineCode",{parentName:"p"},"foo/public"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Copy the contents of ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old/src")," into ",(0,r.kt)("inlineCode",{parentName:"p"},"foo/src"),".\n",(0,r.kt)("inlineCode",{parentName:"p"},"foo/src")," should now contain ",(0,r.kt)("inlineCode",{parentName:"p"},"vite-env.d.ts"),", ",(0,r.kt)("inlineCode",{parentName:"p"},".waspignore"),", and three subdirectories (",(0,r.kt)("inlineCode",{parentName:"p"},"server"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"client"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"shared"),").\nDon't change anything about this structure yet.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Delete redundant files and folders from ",(0,r.kt)("inlineCode",{parentName:"p"},"foo/src"),":"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"foo/src/.waspignore")," - A new version of this file already exists at the top level."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"foo/src/client/vite-env.d.ts")," - A new version of this file already exists at the top level."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"foo/src/client/tsconfig.json")," - A new version of this file already exists at the top level."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"foo/src/server/tsconfig.json")," - A new version of this file already exists at the top level."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"foo/src/shared/tsconfig.json")," - A new version of this file already exists at the top level."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"foo/src/client/public")," - You've moved all the files from this directory in step 5."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Update all the ",(0,r.kt)("inlineCode",{parentName:"p"},"@wasp")," imports in your JS(X)/TS(X) source files in the ",(0,r.kt)("inlineCode",{parentName:"p"},"src/")," dir."),(0,r.kt)("p",{parentName:"li"},"For this, we prepared a special script that will rewrite these imports automatically for you."),(0,r.kt)("p",{parentName:"li"},"Before doing this step, as the script will modify your JS(X)/TS(X) files in place, we advise committing\nall changes you have so far, so you can then both easily inspect the import rewrites that our\nscript did (with ",(0,r.kt)("inlineCode",{parentName:"p"},"git diff"),") and also revert them if something went wrong."),(0,r.kt)("p",{parentName:"li"},"To run the import-rewriting script, make sure you are in the root dir of your wasp project, and then run"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"npx jscodeshift@0.15.1 -t https://raw.githubusercontent.com/wasp-lang/wasp-codemod/main/src/transforms/imports-from-0-11-to-0-12.ts --extensions=js,ts,jsx,tsx src/\n")),(0,r.kt)("p",{parentName:"li"},"Then, check the changes it did, in case some kind of manual intervention is needed (in which case you should see TODO comments generated by the script)."),(0,r.kt)("p",{parentName:"li"},"Alternatively, you can find all the mappings of old imports to the new ones in ",(0,r.kt)("a",{parentName:"p",href:"https://docs.google.com/spreadsheets/d/1QW-_16KRGTOaKXx9NYUtjk6m2TQ0nUMOA74hBthTH3g/edit#gid=1725669920"},"this table")," and use it to fix some/all of them manually.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Replace the Wasp file in ",(0,r.kt)("inlineCode",{parentName:"p"},"foo")," (i.e., ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp"),") with the Wasp file from ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Change the Wasp version field in your Wasp file (now residing in ",(0,r.kt)("inlineCode",{parentName:"p"},"foo"),") to ",(0,r.kt)("inlineCode",{parentName:"p"},'"^0.12.0"'),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Correct external imports in your Wasp file (now residing in ",(0,r.kt)("inlineCode",{parentName:"p"},"foo"),").\nimports. You can do this by running search-and-replace inside the file:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Change all occurrences of ",(0,r.kt)("inlineCode",{parentName:"li"},"@server")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"@src/server")),(0,r.kt)("li",{parentName:"ul"},"Change all occurrences of ",(0,r.kt)("inlineCode",{parentName:"li"},"@client")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"@src/client"))),(0,r.kt)("p",{parentName:"li"},"For example, if you previously had something like:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-js"},'page LoginPage {\n  // highlight-next-line\n  // This previously resolved to src/client/LoginPage.js\n  // highlight-next-line\n  component: import Login from "@client/LoginPage"\n}\n\n// ...\n\nquery getTasks {\n  // highlight-next-line\n  // This previously resolved to src/server/queries.js\n  // highlight-next-line\n  fn: import { getTasks } from "@server/queries.js",\n}\n')),(0,r.kt)("p",{parentName:"li"},"You should change it to:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-js"},'page LoginPage {\n  // highlight-next-line\n  // This now resolves to src/client/LoginPage.js\n  // highlight-next-line\n  component: import Login from "@src/client/LoginPage"\n}\n\n// ...\n\nquery getTasks {\n  // highlight-next-line\n  // This now resolves to src/server/queries.js\n  // highlight-next-line\n  fn: import { getTasks } from "@src/server/queries.js",\n}\n')),(0,r.kt)("p",{parentName:"li"},"Do this for all external imports in your ",(0,r.kt)("inlineCode",{parentName:"p"},".wasp")," file. After you're done, there shouldn't be any occurrences of strings ",(0,r.kt)("inlineCode",{parentName:"p"},'"@server"')," or ",(0,r.kt)("inlineCode",{parentName:"p"},'"@client"'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Take all the dependencies from ",(0,r.kt)("inlineCode",{parentName:"p"},"app.dependencies")," declaration in\n",(0,r.kt)("inlineCode",{parentName:"p"},"foo/main.wasp")," and move them to ",(0,r.kt)("inlineCode",{parentName:"p"},"foo/package.json"),". Make sure to remove the ",(0,r.kt)("inlineCode",{parentName:"p"},"app.dependencies")," field from ",(0,r.kt)("inlineCode",{parentName:"p"},"foo/main.wasp"),"."),(0,r.kt)("p",{parentName:"li"},"For example, if ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old/main.wasp")," had:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-css"},"app Foo {\n  // ...\n  dependencies: [ ('redux', '^4.0.5'), ('reacjt-redux', '^7.1.3')];\n}\n")),(0,r.kt)("p",{parentName:"li"},"Your ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"foo")," should now list these dependencies (Wasp already generated most of the file, you just have to list additional dependencies)."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "foo",\n  "dependencies": {\n    "wasp": "file:.wasp/out/sdk/wasp",\n    "react": "^18.2.0",\n    // highlight-next-line\n    "redux": "^4.0.5",\n    // highlight-next-line\n    "reactjs-redux": "^7.1.3"\n  },\n  "devDependencies": {\n    "typescript": "^5.1.0",\n    "vite": "^4.3.9",\n    "@types/react": "^18.0.37",\n    "prisma": "4.16.2"\n  }\n}\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Copy all lines you might have added to ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old/.gitignore")," into\n",(0,r.kt)("inlineCode",{parentName:"p"},"foo/.gitignore"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Copy the rest of the top-level files and folders (all of them except for ",(0,r.kt)("inlineCode",{parentName:"p"},".gitignore"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"src/"),")\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old/")," into ",(0,r.kt)("inlineCode",{parentName:"p"},"foo/")," (overwrite the existing files in ",(0,r.kt)("inlineCode",{parentName:"p"},"foo"),").")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Run ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp clean")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"foo"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Delete the ",(0,r.kt)("inlineCode",{parentName:"p"},"foo_old")," directory."))))),(0,r.kt)("p",null,"That's it! You now have a properly structured Wasp 0.12.0 project in the ",(0,r.kt)("inlineCode",{parentName:"p"},"foo")," directory.\nYour app probably doesn't quite work yet due to some other changes in Wasp 0.12.0, but we'll get to that in the next sections."),(0,r.kt)("h3",{id:"migrating-declaration-names"},"Migrating declaration names"),(0,r.kt)("p",null,"Wasp 0.12.0 adds a casing constraints when naming Queries, Actions, Jobs, and Entities in the ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file."),(0,r.kt)("p",null,"The following casing conventions have now become mandatory:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Operation (i.e., Query and Action) names must begin with a lowercase letter: ",(0,r.kt)("inlineCode",{parentName:"li"},"query getTasks {...}"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"action createTask {...}"),"."),(0,r.kt)("li",{parentName:"ul"},"Job names must begin with a lowercase letter: ",(0,r.kt)("inlineCode",{parentName:"li"},"job sendReport {...}"),"."),(0,r.kt)("li",{parentName:"ul"},"Entity names must start with an uppercase letter: ",(0,r.kt)("inlineCode",{parentName:"li"},"entity Task {...}"),".")),(0,r.kt)("h3",{id:"migrating-the-tailwind-setup"},"Migrating the Tailwind Setup"),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"If you don't use Tailwind in your project, you can skip this section.")),(0,r.kt)("p",null,"There is a small change in how the ",(0,r.kt)("inlineCode",{parentName:"p"},"tailwind.config.cjs")," needs to be defined in Wasp 0.12.0."),(0,r.kt)("p",null,"You'll need to wrap all your paths in the ",(0,r.kt)("inlineCode",{parentName:"p"},"content")," field with the ",(0,r.kt)("inlineCode",{parentName:"p"},"resolveProjectPath")," function. This makes sure that the paths are resolved correctly when generating your CSS."),(0,r.kt)("p",null,"Here's how you can do it:"),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"before",label:"Before",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="tailwind.config.cjs"',title:'"tailwind.config.cjs"'},"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\n    // highlight-next-line\n    './src/**/*.{js,jsx,ts,tsx}',\n  ],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n}\n"))),(0,r.kt)(i.Z,{value:"after",label:"After",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="tailwind.config.cjs"',title:'"tailwind.config.cjs"'},"// highlight-next-line\nconst { resolveProjectPath } = require('wasp/dev')\n\n/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\n    // highlight-next-line\n    resolveProjectPath('./src/**/*.{js,jsx,ts,tsx}'),\n  ],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n}\n")))),(0,r.kt)("h3",{id:"default-server-dockerfile-changed"},"Default Server Dockerfile Changed"),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"If you didn't customize your Dockerfile or had a custom build process for the Wasp server, you can skip this section.")),(0,r.kt)("p",null,"Between Wasp 0.11.X and 0.12.X, the Dockerfile that Wasp generates for you for deploying the server has changed. If you defined a custom Dockerfile in your project root dir or in any other way relied on its contents, you'll need to update it to incorporate the changes that Wasp 0.12.X made."),(0,r.kt)("p",null,"We suggest that you temporarily move your custom Dockerfile to a different location, then run ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp start")," to generate the new Dockerfile.\nCheck out the ",(0,r.kt)("inlineCode",{parentName:"p"},".wasp/out/Dockerfile")," to see the new Dockerfile and what changes you need to make. You'll probably need to copy some of the changes from the new Dockerfile to your custom one to make your app work with Wasp 0.12.X."),(0,r.kt)("h3",{id:"migrating-to-the-new-auth"},"Migrating to the New Auth"),(0,r.kt)("p",null,"As shown in ",(0,r.kt)("a",{parentName:"p",href:"#new-auth"},"the previous section"),", Wasp significantly changed how authentication works in version 0.12.0.\nThis section leads you through migrating your app from Wasp 0.11.X to Wasp 0.12.X."),(0,r.kt)("p",null,"Migrating your existing app to the new auth system is a two-step process:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Migrate to the new auth system"),(0,r.kt)("li",{parentName:"ol"},"Clean up the old auth system")),(0,r.kt)("admonition",{title:"Migrating a deployed app",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"While going through these steps, we will focus first on doing the changes locally (including your local development database)."),(0,r.kt)("p",{parentName:"admonition"},"Once we confirm everything works well locally, we will apply the same changes to the deployed app (including your production database)."),(0,r.kt)("p",{parentName:"admonition"},(0,r.kt)("strong",{parentName:"p"},"We'll put extra info for migrating a deployed app in a box like this one."))),(0,r.kt)("h4",{id:"1-migrate-to-the-new-auth-system"},"1. Migrate to the New Auth System"),(0,r.kt)("p",null,"You can follow these steps to migrate to the new auth system (assuming you already migrated the project structure to 0.12, as described ",(0,r.kt)("a",{parentName:"p",href:"#migrating-your-project-to-the-new-structure"},"above"),"):"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Migrate ",(0,r.kt)("inlineCode",{parentName:"strong"},"getUserFields")," and/or ",(0,r.kt)("inlineCode",{parentName:"strong"},"additionalSignupFields")," in the ",(0,r.kt)("inlineCode",{parentName:"strong"},"main.wasp")," file to the new ",(0,r.kt)("inlineCode",{parentName:"strong"},"userSignupFields")," field.")," "),(0,r.kt)("p",{parentName:"li"},"If you are not using them, you can skip this step."),(0,r.kt)("p",{parentName:"li"},"In Wasp 0.11.X, you could define a ",(0,r.kt)("inlineCode",{parentName:"p"},"getUserFieldsFn")," to specify extra fields that would get saved to the ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," when using Google or GitHub to sign up."),(0,r.kt)("p",{parentName:"li"},"You could also define ",(0,r.kt)("inlineCode",{parentName:"p"},"additionalSignupFields")," to specify extra fields for the Email or Username & Password signup."),(0,r.kt)("p",{parentName:"li"},"In 0.12.X, we unified these two concepts into the ",(0,r.kt)("inlineCode",{parentName:"p"},"userSignupFields")," field."),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Migration for ",(0,r.kt)(s.ge,{mdxType:"EmailPill"})," and ",(0,r.kt)(s.f3,{mdxType:"UsernameAndPasswordPill"})),(0,r.kt)("p",{parentName:"li"},"  First, move the value of ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.signup.additionalFields")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.{method}.userSignupFields")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file."),(0,r.kt)("p",{parentName:"li"},"  ",(0,r.kt)("inlineCode",{parentName:"p"},"{method}")," depends on the auth method you are using. For example, if you are using the email auth method, you should move the ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.signup.additionalFields")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.email.userSignupFields"),"."),(0,r.kt)("p",{parentName:"li"},"  To finish, update the JS/TS implementation to use the ",(0,r.kt)("inlineCode",{parentName:"p"},"defineUserSignupFields")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp/server/auth")," instead of ",(0,r.kt)("inlineCode",{parentName:"p"},"defineAdditionalSignupFields")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"@wasp/auth/index.js"),"."),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"before",label:"Before",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'app crudTesting {\n  // ...\n  auth: {\n    userEntity: User,\n    methods: {\n      email: {},\n    },\n    onAuthFailedRedirectTo: "/login",\n    // highlight-start\n    signup: {\n      additionalFields: import { fields } from "@server/auth/signup.js",\n    },\n    // highlight-end\n  },\n}\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/server/auth/signup.ts"',title:'"src/server/auth/signup.ts"'},"// highlight-next-line\nimport { defineAdditionalSignupFields } from '@wasp/auth/index.js'\n\n// highlight-next-line\nexport const fields = defineAdditionalSignupFields({\n  address: async (data) => {\n    const address = data.address\n    if (typeof address !== 'string') {\n      throw new Error('Address is required')\n    }\n    if (address.length < 5) {\n      throw new Error('Address must be at least 5 characters long')\n    }\n    return address\n  },\n})\n"))),(0,r.kt)(i.Z,{value:"after",label:"After",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'app crudTesting {\n  // ...\n  auth: {\n    userEntity: User,\n    methods: {\n      email: {\n        // highlight-next-line\n        userSignupFields: import { fields } from "@src/server/auth/signup.js",\n      },\n    },\n    onAuthFailedRedirectTo: "/login",\n  },\n}\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/server/auth/signup.ts"',title:'"src/server/auth/signup.ts"'},"// highlight-next-line\nimport { defineUserSignupFields } from 'wasp/server/auth'\n\n// highlight-next-line\nexport const fields = defineUserSignupFields({\n  address: async (data) => {\n    const address = data.address;\n    if (typeof address !== 'string') {\n      throw new Error('Address is required');\n    }\n    if (address.length < 5) {\n      throw new Error('Address must be at least 5 characters long');\n    }\n    return address;\n  },\n})\n")),(0,r.kt)("p",{parentName:"li"},"  Read more about the ",(0,r.kt)("inlineCode",{parentName:"p"},"userSignupFields")," function ",(0,r.kt)("a",{parentName:"p",href:"/docs/0.15.0/auth/overview#1-defining-extra-fields"},"here"),".")))),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Migration for ",(0,r.kt)(s.xS,{mdxType:"GithubPill"})," and ",(0,r.kt)(s.p5,{mdxType:"GooglePill"})),(0,r.kt)("p",{parentName:"li"},"  First, move the value of ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.{method}.getUserFieldsFn")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.{method}.userSignupFields")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file."),(0,r.kt)("p",{parentName:"li"},"  ",(0,r.kt)("inlineCode",{parentName:"p"},"{method}")," depends on the auth method you are using. For example, if you are using Google auth, you should move the ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.google.getUserFieldsFn")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.google.userSignupFields"),"."),(0,r.kt)("p",{parentName:"li"},"  To finish, update the JS/TS implementation to use the ",(0,r.kt)("inlineCode",{parentName:"p"},"defineUserSignupFields")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp/server/auth")," and modify the code to return the fields in the format that ",(0,r.kt)("inlineCode",{parentName:"p"},"defineUserSignupFields")," expects."),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"before",label:"Before",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'app crudTesting {\n  // ...\n  auth: {\n    userEntity: User,\n    methods: {\n      google: {\n        // highlight-next-line\n        getUserFieldsFn: import { getUserFields } from "@server/auth/google.js"\n      },\n    },\n    onAuthFailedRedirectTo: "/login",\n  },\n}\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/server/auth/google.ts"',title:'"src/server/auth/google.ts"'},"// highlight-next-line\nimport type { GetUserFieldsFn } from '@wasp/types'\n\n// highlight-start\nexport const getUserFields: GetUserFieldsFn = async (_context, args) => {\n  const displayName = args.profile.displayName\n  return { displayName }\n}\n// highlight-end\n"))),(0,r.kt)(i.Z,{value:"after",label:"After",mdxType:"TabItem"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'app crudTesting {\n  // ...\n  auth: {\n    userEntity: User,\n    methods: {\n      google: {\n        // highlight-next-line\n        userSignupFields: import { fields } from "@src/server/auth/google.js",\n      },\n    },\n    onAuthFailedRedirectTo: "/login",\n  },\n}\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/server/auth/signup.ts"',title:'"src/server/auth/signup.ts"'},"// highlight-next-line\nimport { defineUserSignupFields } from 'wasp/server/auth'\n\n// highlight-start\nexport const fields = defineUserSignupFields({\n  displayName: async (data) => {\n    const profile: any = data.profile;\n    if (!profile?.displayName) { throw new Error('Display name is not available'); }\n    return profile.displayName;\n  },\n})\n// highlight-end\n")),(0,r.kt)("p",{parentName:"li"},"  If you want to properly type the ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")," object, we recommend you use a validation library like Zod to define the shape of the ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")," object."),(0,r.kt)("p",{parentName:"li"},"  Read more about this and the ",(0,r.kt)("inlineCode",{parentName:"p"},"defineUserSignupFields")," function in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/0.15.0/auth/overview#1-defining-extra-fields"},"Auth Overview - Defining Extra Fields")," section."))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Remove the ",(0,r.kt)("inlineCode",{parentName:"strong"},"auth.methods.email.allowUnverifiedLogin")," field")," from your ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file."),(0,r.kt)("p",{parentName:"li"},"In Wasp 0.12.X we removed the ",(0,r.kt)("inlineCode",{parentName:"p"},"auth.methods.email.allowUnverifiedLogin")," field to make our Email auth implementation easier to reason about. If you were using it, you should remove it from your ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Ensure your ",(0,r.kt)("strong",{parentName:"p"},"local development database is running"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Do the schema migration")," (create the new auth tables in the database) by running:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wasp db migrate-dev\n")),(0,r.kt)("p",{parentName:"li"},"You should see the new ",(0,r.kt)("inlineCode",{parentName:"p"},"Auth"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthIdentity")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Session")," tables in your database. You can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp db studio")," command to open the database in a GUI and verify the tables are there. At the moment, they will be empty.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Do the data migration")," (move existing users from the old auth system to the new one by filling the new auth tables in the database with their data):"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Implement your data migration function(s)")," in e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"src/migrateToNewAuth.ts"),"."),(0,r.kt)("p",{parentName:"li"},"Below we prepared ",(0,r.kt)("a",{parentName:"p",href:"#example-data-migration-functions"},"examples of migration functions")," for each of the auth methods, for you to use as a starting point.\nThey should be fine to use as-is, meaning you can just copy them and they are likely to work out of the box for typical use cases, but you can also modify them for your needs."),(0,r.kt)("p",{parentName:"li"},"We recommend you create one function per each auth method that you use in your app.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Define custom API endpoints for each migration function")," you implemented."),(0,r.kt)("p",{parentName:"li"},"With each data migration function below, we provided a relevant ",(0,r.kt)("inlineCode",{parentName:"p"},"api")," declaration that you should add to your ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Run the data migration function(s)")," on the local development database by calling the API endpoints you defined in the previous step."),(0,r.kt)("p",{parentName:"li"},"You can call the endpoint by visiting the URL in your browser, or by using a tool like ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," or Postman. "),(0,r.kt)("p",{parentName:"li"},"For example, if you defined the API endpoint at ",(0,r.kt)("inlineCode",{parentName:"p"},"/migrate-username-and-password"),", you can call it by visiting ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:3001/migrate-username-and-password")," in your browser."),(0,r.kt)("p",{parentName:"li"},"This should be it, you can now run ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp db studio")," again and verify that there is now relevant data in the new auth tables (",(0,r.kt)("inlineCode",{parentName:"p"},"Auth")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthIdentity"),"; ",(0,r.kt)("inlineCode",{parentName:"p"},"Session")," should still be empty for now).")))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Verify that the basic auth functionality works")," by running ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp start")," and successfully signing up / logging in with each of the auth methods.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Update your JS/TS code")," to work correctly with the new auth."),(0,r.kt)("p",{parentName:"li"}," You might want to use the new auth helper functions to get the ",(0,r.kt)("inlineCode",{parentName:"p"},"email")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"username")," from a user object. For example, ",(0,r.kt)("inlineCode",{parentName:"p"},"user.username")," might not work anymore for you, since the ",(0,r.kt)("inlineCode",{parentName:"p"},"username")," obtained by the Username & Password auth method isn't stored on the ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," entity anymore (unless you are explicitly storing something into ",(0,r.kt)("inlineCode",{parentName:"p"},"user.username"),", e.g. via ",(0,r.kt)("inlineCode",{parentName:"p"},"userSignupFields")," for a social auth method like Github). Same goes for ",(0,r.kt)("inlineCode",{parentName:"p"},"email")," from Email auth method. "),(0,r.kt)("p",{parentName:"li"},"Instead, you can now use ",(0,r.kt)("inlineCode",{parentName:"p"},"getUsername(user)")," to get the username obtained from Username & Password auth method, or ",(0,r.kt)("inlineCode",{parentName:"p"},"getEmail(user)")," to get the email obtained from Email auth method."),(0,r.kt)("p",{parentName:"li"},"Read more about the helpers in the ",(0,r.kt)("a",{parentName:"p",href:"../auth/entities#accessing-the-auth-fields"},"Accessing User Data")," section.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Finally, ",(0,r.kt)("strong",{parentName:"p"},"check that your app now fully works as it worked before"),". If all the above steps were done correctly, everything should be working now."),(0,r.kt)("admonition",{parentName:"li",title:"Migrating a deployed app",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"After successfully performing migration locally so far, and verifying that your app works as expected, it is time to also migrate our deployed app."),(0,r.kt)("p",{parentName:"admonition"},"Before migrating your production (deployed) app, we advise you to back up your production database in case something goes wrong. Also, besides testing it in development, it's good to test the migration in a staging environment if you have one."),(0,r.kt)("p",{parentName:"admonition"},"We will perform the production migration in 2 steps:"),(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},"Deploying the new code to production (client and server)."),(0,r.kt)("li",{parentName:"ul"},"Migrating the production database data.")),(0,r.kt)("hr",{parentName:"admonition"}),(0,r.kt)("p",{parentName:"admonition"},"Between these two steps, so after successfully deploying the new code to production and before migrating the production database data, your app will not be working completely: new users will be able to sign up, but existing users won't be able to log in, and already logged in users will be logged out. Once you do the second step, migrating the production database data, it will all be back to normal. You will likely want to keep the time between the two steps as short as you can."),(0,r.kt)("hr",{parentName:"admonition"}),(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"First step: deploy the new code")," (client and server), either via ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp deploy")," (i.e. ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp deploy fly deploy"),") or manually."),(0,r.kt)("p",{parentName:"li"},"Check our ",(0,r.kt)("a",{parentName:"p",href:"/docs/0.15.0/advanced/deployment/overview"},"Deployment docs")," for more details.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Second step: run the data migration functions")," on the production database."),(0,r.kt)("p",{parentName:"li"},"You can do this by calling the API endpoints you defined in the previous step, just like you did locally. You can call the endpoint by visiting the URL in your browser, or by using a tool like ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," or Postman. "),(0,r.kt)("p",{parentName:"li"},"For example, if you defined the API endpoint at ",(0,r.kt)("inlineCode",{parentName:"p"},"/migrate-username-and-password"),", you can call it by visiting ",(0,r.kt)("inlineCode",{parentName:"p"},"https://your-server-url.com/migrate-username-and-password")," in your browser."))),(0,r.kt)("p",{parentName:"admonition"},"Your deployed app should be working normally now, with the new auth system.")))),(0,r.kt)("h4",{id:"2-cleanup-the-old-auth-system"},"2. Cleanup the Old Auth System"),(0,r.kt)("p",null,"Your app should be working correctly and using new auth, but to finish the migration, we need to clean up the old auth system:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file, ",(0,r.kt)("strong",{parentName:"p"},"delete auth-related fields from the ",(0,r.kt)("inlineCode",{parentName:"strong"},"User")," entity"),", since with 0.12 they got moved to the internal Wasp entity ",(0,r.kt)("inlineCode",{parentName:"p"},"AuthIdentity"),"."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"This means any fields that were required by Wasp for authentication, like ",(0,r.kt)("inlineCode",{parentName:"li"},"email"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"password"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"isEmailVerified"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"emailVerificationSentAt"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"passwordResetSentAt"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"username"),", etc."),(0,r.kt)("li",{parentName:"ul"},"There are situations in which you might want to keep some of them, e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"email")," and/or ",(0,r.kt)("inlineCode",{parentName:"li"},"username"),", if they are still relevant for you due to your custom logic (e.g. you are populating them with ",(0,r.kt)("inlineCode",{parentName:"li"},"userSignupFields")," upon social signup in order to have this info easily available on the ",(0,r.kt)("inlineCode",{parentName:"li"},"User")," entity). Note that they won't be used by Wasp Auth anymore, they are here just for your business logic."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file, ",(0,r.kt)("strong",{parentName:"p"},"remove the ",(0,r.kt)("inlineCode",{parentName:"strong"},"externalAuthEntity")," field from the ",(0,r.kt)("inlineCode",{parentName:"strong"},"app.auth"))," and also ",(0,r.kt)("strong",{parentName:"p"},"remove the whole ",(0,r.kt)("inlineCode",{parentName:"strong"},"SocialLogin")," entity")," if you used Google or GitHub auth.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Delete the data migration function(s)")," you implemented earlier (e.g. in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/migrateToNewAuth.ts"),") and also the corresponding API endpoints from the ",(0,r.kt)("inlineCode",{parentName:"p"},"main.wasp")," file.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Run ",(0,r.kt)("inlineCode",{parentName:"strong"},"wasp db migrate-dev"))," again to apply these changes and remove the redundant fields from the database."))),(0,r.kt)("admonition",{title:"Migrating a deployed app",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"  After doing the steps above successfully locally and making sure everything is working, it is time to push these changes to the deployed app again."),(0,r.kt)("p",{parentName:"admonition"},"  ",(0,r.kt)("em",{parentName:"p"},"Deploy the app again"),", either via ",(0,r.kt)("inlineCode",{parentName:"p"},"wasp deploy")," or manually. Check our ",(0,r.kt)("a",{parentName:"p",href:"/docs/0.15.0/advanced/deployment/overview"},"Deployment docs")," for more details."),(0,r.kt)("p",{parentName:"admonition"},"  The database migrations will automatically run on successful deployment of the server and delete the now redundant auth-related ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," columns from the database."),(0,r.kt)("p",{parentName:"admonition"},"  Your app is now fully migrated to the new auth system.")),(0,r.kt)("h3",{id:"next-steps"},"Next Steps"),(0,r.kt)("p",null,"If you made it this far, you've completed all the necessary steps to get your\nWasp app working with Wasp 0.12.x. Nice work!"),(0,r.kt)("p",null,"Finally, since Wasp no longer requires you to separate your client source files\n(previously in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/client"),") from server source files (previously in\n",(0,r.kt)("inlineCode",{parentName:"p"},"src/server"),"), you are now free to reorganize your project however you think is best,\nas long as you keep all the source files in the ",(0,r.kt)("inlineCode",{parentName:"p"},"src/")," directory."),(0,r.kt)("p",null,"This section is optional, but if you didn't like the server/client\nseparation, now's the perfect time to change it."),(0,r.kt)("p",null,"For example, if your ",(0,r.kt)("inlineCode",{parentName:"p"},"src")," dir looked like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"src\n\u2502\n\u251c\u2500\u2500 client\n\u2502\xa0\xa0 \u251c\u2500\u2500 Dashboard.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 Login.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 MainPage.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 Register.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 Task.css\n\u2502\xa0\xa0 \u251c\u2500\u2500 TaskLisk.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 Task.tsx\n\u2502\xa0\xa0 \u2514\u2500\u2500 User.tsx\n\u251c\u2500\u2500 server\n\u2502\xa0\xa0 \u251c\u2500\u2500 taskActions.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 taskQueries.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 userActions.ts\n\u2502\xa0\xa0 \u2514\u2500\u2500 userQueries.ts\n\u2514\u2500\u2500 shared\n    \u2514\u2500\u2500 utils.ts\n")),(0,r.kt)("p",null,"you can now change it to a feature-based structure (which we recommend for any project that is not very small):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"src\n\u2502\n\u251c\u2500\u2500 task\n\u2502\xa0\xa0 \u251c\u2500\u2500 actions.ts    -- former taskActions.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 queries.ts    -- former taskQueries.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 Task.css\n\u2502\xa0\xa0 \u251c\u2500\u2500 TaskLisk.tsx\n\u2502\xa0\xa0 \u2514\u2500\u2500 Task.tsx\n\u251c\u2500\u2500 user\n\u2502\xa0\xa0 \u251c\u2500\u2500 actions.ts    -- former userActions.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 Dashboard.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 Login.tsx\n\u2502\xa0\xa0 \u251c\u2500\u2500 queries.ts    -- former userQueries.ts\n\u2502\xa0\xa0 \u251c\u2500\u2500 Register.tsx\n\u2502\xa0\xa0 \u2514\u2500\u2500 User.tsx\n\u251c\u2500\u2500 MainPage.tsx\n\u2514\u2500\u2500 utils.ts\n")),(0,r.kt)("h2",{id:"appendix"},"Appendix"),(0,r.kt)("h3",{id:"example-data-migration-functions"},"Example Data Migration Functions"),(0,r.kt)("p",null,"The migration functions provided below are written with the typical use cases in mind and you can use them as-is. If your setup requires additional logic, you can use them as a good starting point and modify them to your needs."),(0,r.kt)("p",null,"Note that all of the functions below are written to be idempotent, meaning that running a function multiple times can't hurt. This allows executing a function again in case only a part of the previous execution succeeded and also means that accidentally running it one time too much won't have any negative effects. ",(0,r.kt)("strong",{parentName:"p"},"We recommend you keep your data migration functions idempotent"),"."),(0,r.kt)("h4",{id:"username--password"},"Username & Password"),(0,r.kt)("p",null,"To successfully migrate the users using the Username & Password auth method, you will need to do two things:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Migrate the user data"),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Username & Password data migration function"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'api migrateUsernameAndPassword {\n  httpRoute: (GET, "/migrate-username-and-password"),\n  fn: import { migrateUsernameAndPasswordHandler } from "@src/migrateToNewAuth",\n  entities: []\n}\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/migrateToNewAuth.ts"',title:'"src/migrateToNewAuth.ts"'},'import { prisma } from "wasp/server";\nimport { type ProviderName, type UsernameProviderData } from "wasp/server/auth";\nimport { MigrateUsernameAndPassword } from "wasp/server/api";\n\nexport const migrateUsernameAndPasswordHandler: MigrateUsernameAndPassword =\n  async (_req, res) => {\n    const result = await migrateUsernameAuth();\n\n    res.status(200).json({ message: "Migrated users to the new auth", result });\n  };\n\nasync function migrateUsernameAuth(): Promise<{\n  numUsersAlreadyMigrated: number;\n  numUsersNotUsingThisAuthMethod: number;\n  numUsersMigratedSuccessfully: number;\n}> {\n  const users = await prisma.user.findMany({\n    include: {\n      auth: true,\n    },\n  });\n\n  const result = {\n    numUsersAlreadyMigrated: 0,\n    numUsersNotUsingThisAuthMethod: 0,\n    numUsersMigratedSuccessfully: 0,\n  };\n\n  for (const user of users) {\n    if (user.auth) {\n      result.numUsersAlreadyMigrated++;\n      console.log("Skipping user (already migrated) with id:", user.id);\n      continue;\n    }\n\n    if (!user.username || !user.password) {\n      result.numUsersNotUsingThisAuthMethod++;\n      console.log("Skipping user (not using username auth) with id:", user.id);\n      continue;\n    }\n\n    const providerData: UsernameProviderData = {\n      hashedPassword: user.password,\n    };\n    const providerName: ProviderName = "username";\n\n    await prisma.auth.create({\n      data: {\n        identities: {\n          create: {\n            providerName,\n            providerUserId: user.username.toLowerCase(),\n            providerData: JSON.stringify(providerData),\n          },\n        },\n        user: {\n          connect: {\n            id: user.id,\n          },\n        },\n      },\n    });\n    result.numUsersMigratedSuccessfully++;\n  }\n\n  return result;\n}\n')))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Provide a way for users to migrate their password "),(0,r.kt)("p",{parentName:"li"},"There is a ",(0,r.kt)("strong",{parentName:"p"},"breaking change between the old and the new auth in the way the password is hashed"),". This means that users will need to migrate their password after the migration, as the old password will no longer work."),(0,r.kt)("p",{parentName:"li"},"Since the only way users using username and password as a login method can verify their identity is by providing both their username and password (there is no email or any other info, unless you asked for it and stored it explicitly), we need to provide them a way to ",(0,r.kt)("strong",{parentName:"p"},"exchange their old password for a new password"),". One way to handle this is to inform them about the need to migrate their password (on the login page) and provide a custom page to migrate the password. "))),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Steps to create a custom page for migrating the password"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"You will need to install the ",(0,r.kt)("inlineCode",{parentName:"p"},"secure-password")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"sodium-native")," packages to use the old hashing algorithm:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install secure-password@4.0.0 sodium-native@3.3.0 --save-exact\n")),(0,r.kt)("p",{parentName:"li"},"Make sure to save the exact versions of the packages.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Then you'll need to create a new page in your app where users can migrate their password. You can use the following code as a starting point:"))),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'route MigratePasswordRoute { path: "/migrate-password", to: MigratePassword }\npage MigratePassword {\n  component: import { MigratePasswordPage } from "@src/pages/MigratePassword"\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src/pages/MigratePassword.jsx"',title:'"src/pages/MigratePassword.jsx"'},'import {\n  FormItemGroup,\n  FormLabel,\n  FormInput,\n  FormError,\n} from "wasp/client/auth";\nimport { useForm } from "react-hook-form";\nimport { migratePassword } from "wasp/client/operations";\nimport { useState } from "react";\n\nexport function MigratePasswordPage() {\n  const [successMessage, setSuccessMessage] = useState(null);\n  const [errorMessage, setErrorMessage] = useState(null);\n  const form = useForm();\n\n  const onSubmit = form.handleSubmit(async (data) => {\n    try {\n      const result = await migratePassword(data);\n      setSuccessMessage(result.message);\n    } catch (e) {\n      console.error(e);\n      if (e instanceof Error) {\n        setErrorMessage(e.message);\n      }\n    }\n  });\n\n  return (\n    <div style={{\n      maxWidth: "400px",\n      margin: "auto",\n    }}>\n      <h1>Migrate your password</h1>\n      <p>\n        If you have an account on the old version of the website, you can\n        migrate your password to the new version.\n      </p>\n      {successMessage && <div>{successMessage}</div>}\n      {errorMessage && <FormError>{errorMessage}</FormError>}\n      <form onSubmit={onSubmit}>\n        <FormItemGroup>\n          <FormLabel>Username</FormLabel>\n          <FormInput\n            {...form.register("username", {\n              required: "Username is required",\n            })}\n          />\n          <FormError>{form.formState.errors.username?.message}</FormError>\n        </FormItemGroup>\n        <FormItemGroup>\n          <FormLabel>Password</FormLabel>\n          <FormInput\n            {...form.register("password", {\n              required: "Password is required",\n            })}\n            type="password"\n          />\n          <FormError>{form.formState.errors.password?.message}</FormError>\n        </FormItemGroup>\n        <button type="submit">Migrate password</button>\n      </form>\n    </div>\n  );\n}\n'))),(0,r.kt)(i.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'route MigratePasswordRoute { path: "/migrate-password", to: MigratePassword }\npage MigratePassword {\n  component: import { MigratePasswordPage } from "@src/pages/MigratePassword"\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="src/pages/MigratePassword.tsx"',title:'"src/pages/MigratePassword.tsx"'},'import {\n  FormItemGroup,\n  FormLabel,\n  FormInput,\n  FormError,\n} from "wasp/client/auth";\nimport { useForm } from "react-hook-form";\nimport { migratePassword } from "wasp/client/operations";\nimport { useState } from "react";\n\nexport function MigratePasswordPage() {\n  const [successMessage, setSuccessMessage] = useState<string | null>(null);\n  const [errorMessage, setErrorMessage] = useState<string | null>(null);\n  const form = useForm<{\n    username: string;\n    password: string;\n  }>();\n\n  const onSubmit = form.handleSubmit(async (data) => {\n    try {\n      const result = await migratePassword(data);\n      setSuccessMessage(result.message);\n    } catch (e: unknown) {\n      console.error(e);\n      if (e instanceof Error) {\n        setErrorMessage(e.message);\n      }\n    }\n  });\n\n  return (\n    <div style={{\n      maxWidth: "400px",\n      margin: "auto",\n    }}>\n      <h1>Migrate your password</h1>\n      <p>\n        If you have an account on the old version of the website, you can\n        migrate your password to the new version.\n      </p>\n      {successMessage && <div>{successMessage}</div>}\n      {errorMessage && <FormError>{errorMessage}</FormError>}\n      <form onSubmit={onSubmit}>\n        <FormItemGroup>\n          <FormLabel>Username</FormLabel>\n          <FormInput\n            {...form.register("username", {\n              required: "Username is required",\n            })}\n          />\n          <FormError>{form.formState.errors.username?.message}</FormError>\n        </FormItemGroup>\n        <FormItemGroup>\n          <FormLabel>Password</FormLabel>\n          <FormInput\n            {...form.register("password", {\n              required: "Password is required",\n            })}\n            type="password"\n          />\n          <FormError>{form.formState.errors.password?.message}</FormError>\n        </FormItemGroup>\n        <button type="submit">Migrate password</button>\n      </form>\n    </div>\n  );\n}\n')))),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Finally, you will need to create a new operation in your app to handle the password migration. You can use the following code as a starting point:")),(0,r.kt)(o.Z,{groupId:"js-ts",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"js",label:"JavaScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'action migratePassword {\n  fn: import { migratePassword } from "@src/auth",\n  entities: []\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="src/auth.js"',title:'"src/auth.js"'},'import SecurePassword from "secure-password";\nimport { HttpError } from "wasp/server";\nimport {\n  createProviderId,\n  deserializeAndSanitizeProviderData,\n  findAuthIdentity,\n  updateAuthIdentityProviderData,\n} from "wasp/server/auth";\n\nexport const migratePassword = async ({ password, username }, _context) => {\n  const providerId = createProviderId("username", username);\n  const authIdentity = await findAuthIdentity(providerId);\n\n  if (!authIdentity) {\n    throw new HttpError(400, "Something went wrong");\n  }\n\n  const providerData = deserializeAndSanitizeProviderData(\n    authIdentity.providerData\n  );\n\n  try {\n    const SP = new SecurePassword();\n\n    // This will verify the password using the old algorithm\n    const result = await SP.verify(\n      Buffer.from(password),\n      Buffer.from(providerData.hashedPassword, "base64")\n    );\n\n    if (result !== SecurePassword.VALID) {\n      throw new HttpError(400, "Something went wrong");\n    }\n\n    // This will hash the password using the new algorithm and update the\n    // provider data in the database.\n    await updateAuthIdentityProviderData(providerId, providerData, {\n      hashedPassword: password,\n    });\n  } catch (e) {\n    throw new HttpError(400, "Something went wrong");\n  }\n\n  return {\n    message: "Password migrated successfully.",\n  };\n};\n'))),(0,r.kt)(i.Z,{value:"ts",label:"TypeScript",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'action migratePassword {\n  fn: import { migratePassword } from "@src/auth",\n  entities: []\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/auth.ts"',title:'"src/auth.ts"'},'import SecurePassword from "secure-password";\nimport { HttpError } from "wasp/server";\nimport {\n  createProviderId,\n  deserializeAndSanitizeProviderData,\n  findAuthIdentity,\n  updateAuthIdentityProviderData,\n} from "wasp/server/auth";\nimport { MigratePassword } from "wasp/server/operations";\n\ntype MigratePasswordInput = {\n  username: string;\n  password: string;\n};\ntype MigratePasswordOutput = {\n  message: string;\n};\n\nexport const migratePassword: MigratePassword<\n  MigratePasswordInput,\n  MigratePasswordOutput\n> = async ({ password, username }, _context) => {\n  const providerId = createProviderId("username", username);\n  const authIdentity = await findAuthIdentity(providerId);\n\n  if (!authIdentity) {\n    throw new HttpError(400, "Something went wrong");\n  }\n\n  const providerData = deserializeAndSanitizeProviderData<"username">(\n    authIdentity.providerData\n  );\n\n  try {\n    const SP = new SecurePassword();\n\n    // This will verify the password using the old algorithm\n    const result = await SP.verify(\n      Buffer.from(password),\n      Buffer.from(providerData.hashedPassword, "base64")\n    );\n\n    if (result !== SecurePassword.VALID) {\n      throw new HttpError(400, "Something went wrong");\n    }\n\n    // This will hash the password using the new algorithm and update the\n    // provider data in the database.\n    await updateAuthIdentityProviderData<"username">(providerId, providerData, {\n      hashedPassword: password,\n    });\n  } catch (e) {\n    throw new HttpError(400, "Something went wrong");\n  }\n\n  return {\n    message: "Password migrated successfully.",\n  };\n};\n'))))),(0,r.kt)("h4",{id:"email"},"Email"),(0,r.kt)("p",null,"To successfully migrate the users using the Email auth method, you will need to do two things:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Migrate the user data"),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Email data migration function"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'api migrateEmail {\n  httpRoute: (GET, "/migrate-email"),\n  fn: import { migrateEmailHandler } from "@src/migrateToNewAuth",\n  entities: []\n}\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/migrateToNewAuth.ts"',title:'"src/migrateToNewAuth.ts"'},'import { prisma } from "wasp/server";\nimport { type ProviderName, type EmailProviderData } from "wasp/server/auth";\nimport { MigrateEmail } from "wasp/server/api";\n\nexport const migrateEmailHandler: MigrateEmail =\n  async (_req, res) => {\n    const result = await migrateEmailAuth();\n\n    res.status(200).json({ message: "Migrated users to the new auth", result });\n  };\n\nasync function migrateEmailAuth(): Promise<{\n  numUsersAlreadyMigrated: number;\n  numUsersNotUsingThisAuthMethod: number;\n  numUsersMigratedSuccessfully: number;\n}> {\n  const users = await prisma.user.findMany({\n    include: {\n      auth: true,\n    },\n  });\n\n  const result = {\n    numUsersAlreadyMigrated: 0,\n    numUsersNotUsingThisAuthMethod: 0,\n    numUsersMigratedSuccessfully: 0,\n  };\n\n  for (const user of users) {\n    if (user.auth) {\n      result.numUsersAlreadyMigrated++;\n      console.log("Skipping user (already migrated) with id:", user.id);\n      continue;\n    }\n\n    if (!user.email || !user.password) {\n      result.numUsersNotUsingThisAuthMethod++;\n      console.log("Skipping user (not using email auth) with id:", user.id);\n      continue;\n    }\n\n    const providerData: EmailProviderData = {\n      isEmailVerified: user.isEmailVerified,\n      emailVerificationSentAt:\n        user.emailVerificationSentAt?.toISOString() ?? null,\n      passwordResetSentAt: user.passwordResetSentAt?.toISOString() ?? null,\n      hashedPassword: user.password,\n    };\n    const providerName: ProviderName = "email";\n\n    await prisma.auth.create({\n      data: {\n        identities: {\n          create: {\n            providerName,\n            providerUserId: user.email,\n            providerData: JSON.stringify(providerData),\n          },\n        },\n        user: {\n          connect: {\n            id: user.id,\n          },\n        },\n      },\n    });\n    result.numUsersMigratedSuccessfully++;\n  }\n\n  return result;\n}\n')))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Ask the users to reset their password"),(0,r.kt)("p",{parentName:"li"},"There is a ",(0,r.kt)("strong",{parentName:"p"},"breaking change between the old and the new auth in the way the password is hashed"),". This means that users will need to reset their password after the migration, as the old password will no longer work."),(0,r.kt)("p",{parentName:"li"},"It would be best to notify your users about this change and put a notice on your login page to ",(0,r.kt)("strong",{parentName:"p"},"request a password reset"),"."))),(0,r.kt)("h4",{id:"google--github"},"Google & GitHub"),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Google & GitHub data migration functions"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-wasp",metastring:'title="main.wasp"',title:'"main.wasp"'},'api migrateGoogle {\n  httpRoute: (GET, "/migrate-google"),\n  fn: import { migrateGoogleHandler } from "@src/migrateToNewAuth",\n  entities: []\n}\n\napi migrateGithub {\n  httpRoute: (GET, "/migrate-github"),\n  fn: import { migrateGithubHandler } from "@src/migrateToNewAuth",\n  entities: []\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/migrateToNewAuth.ts"',title:'"src/migrateToNewAuth.ts"'},'import { prisma } from "wasp/server";\nimport { MigrateGoogle, MigrateGithub } from "wasp/server/api";\n\nexport const migrateGoogleHandler: MigrateGoogle =\n  async (_req, res) => {\n    const result = await createSocialLoginMigration("google");\n\n    res.status(200).json({ message: "Migrated users to the new auth", result });\n  };\n\nexport const migrateGithubHandler: MigrateGithub =\n  async (_req, res) => {\n    const result = await createSocialLoginMigration("github");\n\n    res.status(200).json({ message: "Migrated users to the new auth", result });\n  };\n\nasync function createSocialLoginMigration(\n  providerName: "google" | "github"\n): Promise<{\n  numUsersAlreadyMigrated: number;\n  numUsersNotUsingThisAuthMethod: number;\n  numUsersMigratedSuccessfully: number;\n}> {\n  const users = await prisma.user.findMany({\n    include: {\n      auth: true,\n      externalAuthAssociations: true,\n    },\n  });\n\n  const result = {\n    numUsersAlreadyMigrated: 0,\n    numUsersNotUsingThisAuthMethod: 0,\n    numUsersMigratedSuccessfully: 0,\n  };\n\n  for (const user of users) {\n    if (user.auth) {\n      result.numUsersAlreadyMigrated++;\n      console.log("Skipping user (already migrated) with id:", user.id);\n      continue;\n    }\n\n    const provider = user.externalAuthAssociations.find(\n      (provider) => provider.provider === providerName\n    );\n\n    if (!provider) {\n      result.numUsersNotUsingThisAuthMethod++;\n      console.log(`Skipping user (not using ${providerName} auth) with id:`, user.id);\n      continue;\n    }\n\n    await prisma.auth.create({\n      data: {\n        identities: {\n          create: {\n            providerName,\n            providerUserId: provider.providerId,\n            providerData: JSON.stringify({}),\n          },\n        },\n        user: {\n          connect: {\n            id: user.id,\n          },\n        },\n      },\n    });\n    result.numUsersMigratedSuccessfully++;\n  }\n\n  return result;\n}\n'))))}g.isMDXComponent=!0}}]);