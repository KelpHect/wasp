"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[39855],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>h});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var p=n.createContext({}),l=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=l(e.components);return n.createElement(p.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=l(a),u=o,h=m["".concat(p,".").concat(u)]||m[u]||c[u]||i;return a?n.createElement(h,r(r({ref:t},d),{},{components:a})):n.createElement(h,r({ref:t},d))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=u;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[m]="string"==typeof e?e:o,r[1]=s;for(var l=2;l<i;l++)r[l]=a[l];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},46300:(e,t,a)=>{a.d(t,{Z:()=>i});var n=a(67294),o=a(50012);function i(e){let{path:t}=e;const[a]=(0,o.Nk)("docusaurus.tab.js-ts"),i=t.lastIndexOf("{"),r=t.slice(i+1,t.length-1),[s,p]=r.split(","),l=t.slice(0,i);return n.createElement("code",null,l+("js"===a?s:p))}},74895:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var n=a(87462),o=(a(67294),a(3905));a(46300);const i={title:"Database"},r=void 0,s={unversionedId:"deployment/database",id:"version-0.16.0/deployment/database",title:"Database",description:"In this section, we'll discuss what happens with the database when your app goes live. When you develop your app locally, you probably use a local dev database (started with wasp start db or some other way). However, when it's time to deploy your app, you'll need to set up a production database.",source:"@site/versioned_docs/version-0.16.0/deployment/database.md",sourceDirName:"deployment",slug:"/deployment/database",permalink:"/docs/deployment/database",draft:!1,editUrl:"https://github.com/wasp-lang/wasp/edit/release/web/versioned_docs/version-0.16.0/deployment/database.md",tags:[],version:"0.16.0",frontMatter:{title:"Database"},sidebar:"docs",previous:{title:"Env Variables",permalink:"/docs/deployment/env-vars"},next:{title:"Overview",permalink:"/docs/deployment/deployment-methods/overview"}},p={},l=[{value:"Production database requirements",id:"production-database-requirements",level:3},{value:"Migrations",id:"migrations",level:2},{value:"Creating migrations",id:"creating-migrations",level:3},{value:"Applying migrations",id:"applying-migrations",level:3},{value:"Debugging failed migrations",id:"debugging-failed-migrations",level:3},{value:"Connect to the production database",id:"connect-to-the-production-database",level:2}],d={toc:l},m="wrapper";function c(e){let{components:t,...a}=e;return(0,o.kt)(m,(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In this section, we'll discuss what happens with the database when your app goes live. When you develop your app locally, you probably use a local dev database (started with ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp start db")," or some other way). However, when it's time to deploy your app, you'll need to set up a production database."),(0,o.kt)("h3",{id:"production-database-requirements"},"Production database requirements"),(0,o.kt)("p",null,"The server app that Wasp generates uses a PostgreSQL database. The only requirement from Wasp's point of view is that the database is accessible from the server via the ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," server env variable."),(0,o.kt)("p",null,"It can be a PostgreSQL database running on the same server as the server app, or it can be a managed PostgreSQL database service like ",(0,o.kt)("a",{parentName:"p",href:"https://fly.io/docs/postgres/"},"Fly Postgres"),", ",(0,o.kt)("a",{parentName:"p",href:"https://aws.amazon.com/rds/"},"AWS RDS"),", or some other service."),(0,o.kt)("h2",{id:"migrations"},"Migrations"),(0,o.kt)("p",null,"Every time you make a change in your ",(0,o.kt)("a",{parentName:"p",href:"/docs/data-model/prisma-file"},"Prisma schema")," e.g. adding a new model, changing a field type, etc., you need to create a migration. Migrations are some code that describes the change you made in the schema, and they are used to apply the change to the database."),(0,o.kt)("p",null,"The benefit of migrations is that you can apply the same change to multiple databases. If there are multiple people working on the project, they can all apply the same changes to their local databases. When you deploy the app to production, the same chaanges are applied to the production database."),(0,o.kt)("h3",{id:"creating-migrations"},"Creating migrations"),(0,o.kt)("p",null,"After you made a change in the Prisma schema, you can create a migration by running the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"wasp db migrate-dev\n")),(0,o.kt)("p",null,"This command will create a new migration in the ",(0,o.kt)("inlineCode",{parentName:"p"},"migrations")," directory. The migration is a set of SQL commands that describe the change you made in the schema."),(0,o.kt)("h3",{id:"applying-migrations"},"Applying migrations"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"In development"),", the migrations are applied as soon as you run the ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp start")," command."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"In production"),", the server app first checks if there are any new migrations that need to be applied, and if there are, it applies them before starting the server. This way, the database schema is always in sync with the Prisma schema."),(0,o.kt)("admonition",{title:"How it works",type:"note"},(0,o.kt)("p",{parentName:"admonition"},"In the built server app, there are two npm scripts: ",(0,o.kt)("inlineCode",{parentName:"p"},"start")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"start-production"),". The ",(0,o.kt)("inlineCode",{parentName:"p"},"start")," script is used in development, and the ",(0,o.kt)("inlineCode",{parentName:"p"},"start-production")," script is used in production. The ",(0,o.kt)("inlineCode",{parentName:"p"},"start-production")," script first applies any pending migrations before starting the server.")),(0,o.kt)("p",null,"The migrations might fail to apply if there is a conflict with the existing data in the database. In that case, you'll need to fix the migration and try again."),(0,o.kt)("h3",{id:"debugging-failed-migrations"},"Debugging failed migrations"),(0,o.kt)("p",null,"If a migration fails to apply, the server app will log the error message and stop. You should then connect to the production database and see what went wrong. If you check the ",(0,o.kt)("inlineCode",{parentName:"p"},"_prisma_migrations")," table, you'll see the failed migration there."),(0,o.kt)("p",null,"You can try resolving the erorr e.g. if you tried adding a ",(0,o.kt)("inlineCode",{parentName:"p"},"@unique")," constraint to a field that already has duplicate values:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Remove any duplicate values from the database"),(0,o.kt)("li",{parentName:"ol"},"Remove the failed migration from the ",(0,o.kt)("inlineCode",{parentName:"li"},"_prisma_migrations")," table"),(0,o.kt)("li",{parentName:"ol"},"Try applying the migration again by restarting the server app")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("mdxAdmonitionTitle",{parentName:"admonition"},"Viewing the ",(0,o.kt)("inlineCode",{parentName:"mdxAdmonitionTitle"},"_prisma_migrations")," table"),(0,o.kt)("p",{parentName:"admonition"},"You can't use the ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp db studio")," command to view the ",(0,o.kt)("inlineCode",{parentName:"p"},"_prisma_migrations")," table in the production database, but you can use a database management tool like ",(0,o.kt)("a",{parentName:"p",href:"https://dbeaver.io/"},"DBeaver")," or ",(0,o.kt)("a",{parentName:"p",href:"https://www.pgadmin.org/"},"pgAdmin"),".")),(0,o.kt)("h2",{id:"connect-to-the-production-database"},"Connect to the production database"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"In development"),", you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp db studio")," command to open a web-based database management tool that allows you to inspect the database."),(0,o.kt)("p",null,"You can use the same tool to inspect the ",(0,o.kt)("strong",{parentName:"p"},"production database"),", but you'll need to set the ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," env variable to point to the production database. Set the ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," env variable in your terminal before running the ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp db studio")," command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'DATABASE_URL="postgresql://user:password@host:port/dbname" wasp db studio\n')),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("mdxAdmonitionTitle",{parentName:"admonition"},"Be careful with the ",(0,o.kt)("inlineCode",{parentName:"mdxAdmonitionTitle"},"DATABASE_URL")," env variable"),(0,o.kt)("p",{parentName:"admonition"},"Setting the ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," env variable in the ",(0,o.kt)("inlineCode",{parentName:"p"},".env.server")," file to point to your production database also works, but then you might forget to remove it and you could accidentally make changes to the production database when you run ",(0,o.kt)("inlineCode",{parentName:"p"},"wasp start")," in development."),(0,o.kt)("p",{parentName:"admonition"},"That's why we recommend setting the ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," env variable in the terminal to avoid this.")),(0,o.kt)("p",null,"If you are looking how to connect to a Fly.io production database, we wrote a ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/wasp-lang/learning-materials/?tab=readme-ov-file#running-wasp-db-studio-on-production-db"},"guide")," on how to do that."))}c.isMDXComponent=!0}}]);